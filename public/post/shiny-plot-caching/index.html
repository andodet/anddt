<!DOCTYPE html>
<html lang="en-gb">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Caching plots in Shiny | Andrea Dodet</title>
  <link rel = 'canonical' href = 'https://anddt.com/post/shiny-plot-caching/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Caching plots in Shiny" />
<meta property="og:description" content="Bringing Shiny into production Caching plots Measuring speed benefits Closing remarks References  Bringing Shiny into production In the past few days I spent some spare time going through a bunch of old rstudio::conf talks about scaling and deploying Shiny apps into production. Dashboard latency times, load times and general dashboard reactivity come regularly as the main challenges to overcome in order to provide a good user experience and ensure good adoption." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddt.com/post/shiny-plot-caching/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-03-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-03-03T00:00:00+00:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Caching plots in Shiny"/>
<meta name="twitter:description" content="Bringing Shiny into production Caching plots Measuring speed benefits Closing remarks References  Bringing Shiny into production In the past few days I spent some spare time going through a bunch of old rstudio::conf talks about scaling and deploying Shiny apps into production. Dashboard latency times, load times and general dashboard reactivity come regularly as the main challenges to overcome in order to provide a good user experience and ensure good adoption."/>

  
  
  
  <link rel="stylesheet" href="https://anddt.com/scss/style.scss" integrity=""> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://anddt.com/images/favicon.ico" />

  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-58930119-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://anddt.com">
  
    <div id="logo" style="background-image: url(https://anddt.com/images/logo.png)"></div>
  
  <div id="title">
    <h1>Andrea Dodet</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fas fa-bars fa-2x" aria-hidden="true"></i></a>
      </li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <ul>
<li><a href="#bringing-shiny-into-production">Bringing Shiny into production</a></li>
<li><a href="#caching-plots">Caching plots</a></li>
<li><a href="#measuring-speed-benefits">Measuring speed benefits</a></li>
<li><a href="#closing-remarks">Closing remarks</a></li>
<li><a href="#references">References</a></li>
</ul>
<h2 id="bringing-shiny-into-production">Bringing Shiny into production</h2>
<p>In the past few days I spent some spare time going through a bunch of
old <a href="https://rstudio.com/conference/">rstudio::conf</a> talks about scaling
and deploying Shiny apps into production. Dashboard latency times, load
times and general dashboard reactivity come regularly as the main
challenges to overcome in order to provide a good user experience and
ensure good adoption. As a general rule of thumb, the following
strategies seemed to come up regularly in the talks:</p>
<ol>
<li>Move away long running computations and ETL processes away from the
user. Most of the time, it is not necessary to pull and crunch data
from a database every new session. This can be easily avoided by
setting up a CRON job that pulls data and aggregates it overnight.
Your mileage will obviously vary depending on how frequently you’ll
need your data updated.</li>
<li>On the UI side, use dynamic components wisely. One could start with
a fairly simple UI set and add complexity at a later stage via
<code>insertUI</code>/<code>removeUI</code> calls.</li>
<li>When dealing with large data frames, <code>data.table</code> might be preferred
to <code>dplyr</code> for its speed efficiencies.</li>
<li>If your dashboard spends most of the time building plots, caching
them will cut wait times with some caveats that will be explored
later.</li>
<li>Finding bottle necks can be cumbersome in large and complex
dashboards. Profiling the dashboard with
<a href="https://rstudio.github.io/profvis/"><code>profvis</code></a> should clarify where
the dashboard is spending most of its computing time.</li>
</ol>
<p>The following post aims to be a straightforward walk through on how to
implement a simple cache (using <a href="https://redis.io/">Redis</a>) and
analyzing the consequent speed improvements.</p>
<h2 id="caching-plots">Caching plots</h2>
<p>I deeply recommend
<a href="https://shiny.rstudio.com/articles/plot-caching.html">this</a> post from
Winston Chang for exhaustive documentation on the several nuances of
caching plots in Shiny. For clarity’s sake, the following <a href="https://gist.github.com/andodet/fe390ae45127a80e3e526e63fc3f11bf">example
app</a>
will be used as a test throughout this post:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">shiny</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">R6</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">redux</span><span class="p">)</span>

<span class="n">ui</span> <span class="o">&lt;-</span> <span class="nf">fluidPage</span><span class="p">(</span><span class="nf">titlePanel</span><span class="p">(</span><span class="s">&#34;Plot Caching Test&#34;</span><span class="p">),</span>
                
                <span class="nf">sidebarLayout</span><span class="p">(</span><span class="nf">sidebarPanel</span><span class="p">(</span>
                  <span class="nf">selectInput</span><span class="p">(</span><span class="s">&#34;number&#34;</span><span class="p">,</span> <span class="n">choices</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="m">80000</span><span class="p">,</span> <span class="m">100000</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="m">10000</span><span class="p">),</span>
                              <span class="n">label</span> <span class="o">=</span> <span class="s">&#34;Number of points&#34;</span><span class="p">,</span> <span class="n">selected</span> <span class="o">=</span> <span class="m">5000</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="nf">mainPanel</span><span class="p">(</span><span class="nf">plotOutput</span><span class="p">(</span><span class="s">&#34;point_plot&#34;</span><span class="p">))))</span>


<span class="n">server</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">reactive</span><span class="p">({</span>
    <span class="nf">data.frame</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">input</span><span class="o">$</span><span class="n">number</span><span class="p">),</span>
               <span class="n">y</span> <span class="o">=</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">input</span><span class="o">$</span><span class="n">number</span><span class="p">))</span>
  <span class="p">})</span>
  
  <span class="n">output</span><span class="o">$</span><span class="n">point_plot</span> <span class="o">&lt;-</span> <span class="nf">renderCachedPlot</span><span class="p">({</span>
    <span class="nf">ggplot</span><span class="p">(</span><span class="nf">data</span><span class="p">(),</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span>
      <span class="nf">geom_point</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="m">0.8</span><span class="p">)</span> <span class="o">+</span>
      <span class="nf">labs</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#34;Random scatterplot&#34;</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="n">cacheKeyExpr</span> <span class="o">=</span> <span class="p">{</span> <span class="nf">list</span><span class="p">(</span><span class="n">input</span><span class="o">$</span><span class="n">number</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">)</span>
  
  
  <span class="c1"># Set up redis cache object</span>
  <span class="n">RedisCache</span> <span class="o">&lt;-</span> <span class="nf">R6Class</span><span class="p">(</span>
    <span class="s">&#34;RedisCache&#34;</span><span class="p">,</span>
    <span class="n">public</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span>
      <span class="n">initialize</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="kc">...</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">private</span><span class="o">$</span><span class="n">r</span> <span class="o">&lt;-</span> <span class="n">redux</span><span class="o">::</span><span class="nf">hiredis</span><span class="p">(</span><span class="n">host</span> <span class="o">=</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="m">6379</span><span class="p">)</span>
        
        <span class="c1"># Configure 20mb cache</span>
        <span class="n">private</span><span class="o">$</span><span class="n">r</span><span class="o">$</span><span class="nf">CONFIG_SET</span><span class="p">(</span><span class="s">&#34;maxmemory&#34;</span><span class="p">,</span> <span class="s">&#34;20mb&#34;</span><span class="p">)</span>
        <span class="n">private</span><span class="o">$</span><span class="n">r</span><span class="o">$</span><span class="nf">CONFIG_SET</span><span class="p">(</span><span class="s">&#34;maxmemory-policy&#34;</span><span class="p">,</span> <span class="s">&#34;allkeys-lru&#34;</span><span class="p">)</span>
        <span class="n">private</span><span class="o">$</span><span class="n">namespace</span> <span class="o">&lt;-</span> <span class="n">namespace</span>
      <span class="p">},</span>
      
      <span class="n">get</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">key</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">private</span><span class="o">$</span><span class="n">namespace</span><span class="p">,</span> <span class="s">&#34;-&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">s_value</span> <span class="o">&lt;-</span> <span class="n">private</span><span class="o">$</span><span class="n">r</span><span class="o">$</span><span class="nf">GET</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">s_value</span><span class="p">))</span> <span class="p">{</span>
          <span class="nf">return</span><span class="p">(</span><span class="nf">key_missing</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="nf">unserialize</span><span class="p">(</span><span class="n">s_value</span><span class="p">)</span>
      <span class="p">},</span>
      
      <span class="n">set</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">key</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">private</span><span class="o">$</span><span class="n">namespace</span><span class="p">,</span> <span class="s">&#34;-&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">s_value</span> <span class="o">&lt;-</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">NULL</span><span class="p">)</span>
        <span class="n">private</span><span class="o">$</span><span class="n">r</span><span class="o">$</span><span class="nf">SET</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">s_value</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">),</span>
    <span class="n">private</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
                   <span class="n">namespace</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span>
  <span class="p">)</span>
  
  <span class="nf">shinyOptions</span><span class="p">(</span><span class="n">cache</span> <span class="o">=</span> <span class="n">RedisCache</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">namespace</span> <span class="o">=</span> <span class="s">&#34;example_app&#34;</span><span class="p">))</span>
  
<span class="p">}</span>

<span class="nf">shinyApp</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
</code></pre></div><p>From the code above, two main things should be noted:</p>
<ul>
<li>The declaration of a <code>RedisCache</code> object, pointing to the IP address
of the Redis server (in this case a local Redis docker container).</li>
<li><code>cacheKeyExpr</code> declares the UI element that when touched or changed
will invalidate the cache, forcing the plot to be redrawn.</li>
</ul>
<p>Below a screenshot of the resulting example:</p>
<p><img src="/images/2020-03-03-caching-shiny-plots/toy_app.png" alt=""></p>
<p>In this example, a Redis server will be spun up through Docker:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">docker run -d -p 6379:6379 --name cache redis
</code></pre></div><p>It is possible to verify the server has come live correctly by checking
<code>docker ps</code> output.</p>
<h2 id="measuring-speed-benefits">Measuring speed benefits</h2>
<p>Upon interaction with the dropdown menu, the application generates some
data-points and draws a scatterplot, the number of points to be plotted
is large enough to make plotting fairly time consuming. Caching plots is
particularly useful when the same output is frequently requested by
users (e.g weekly sessions, conversion rate by campaign, etc.). In order
to simulate simultaneous multi-user activity,
<a href="https://rstudio.github.io/shinyloadtest/"><code>shinyloadtest</code></a> will be
used. Simulating activity load with <code>shinyloadtest</code> is a two-step
process:</p>
<ol>
<li>
<p>Record a typical user session (e.g interacting with dates,
drop-downs, etc) with<br>
<code>shinyloadtest::record_session(&quot;http://127.0.0.1:3184&quot;)</code><br>
After closing the browser tab a <code>recording.log</code> file will be
generated, encoding all the mock user activity just simulated.</p>
</li>
<li>
<p>Now it is time to launch parallel user sessions with the user
interactions just recorded. For example, something like <code>shinycannon recording.log http://app_url:port --workers 5 --loaded-duration-minutes 3 --output-dir test_run</code> will simulate 5
users, interacting with the app for 3 minutes using the interactions
recorded in <code>recording.log</code>.</p>
</li>
</ol>
<p>In order to better understand the magnitude of speed benefits introduced
by plot-caching, the following scenarios were simulated:</p>
<ul>
<li>25 concurrent users with cache <em>enabled</em></li>
<li>50 concurrent users with cache <em>enabled</em></li>
<li>100 concurrent users with cache <em>enabled</em></li>
<li>200 concurrent users with cache <em>enabled</em></li>
<li>5 concurrent users with cache <em>disabled</em></li>
</ul>
<p>After running all the above scenarios (making sure to flush the cache
each run via <code>docker exec -it cachce redis-cli FLUSHALL</code>), a number of
folder containing logs for each session will be created. <code>shinyloadtest</code>
already has builtin functions to import, parse and compute relevant
metrics from these log files. <em>Total session time</em> will be the main
metric against which performances will be assessed.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">shinyloadtest</span><span class="p">)</span>

<span class="c1"># Import laodtest runs</span>
<span class="n">cached_200</span> <span class="o">&lt;-</span> <span class="nf">load_runs</span><span class="p">(</span><span class="s">&#34;200_users_cached/&#34;</span><span class="p">)</span>
<span class="n">cached_100</span> <span class="o">&lt;-</span> <span class="nf">load_runs</span><span class="p">(</span><span class="s">&#34;100_users_cached/&#34;</span><span class="p">)</span>
<span class="n">cached_50</span> <span class="o">&lt;-</span> <span class="nf">load_runs</span><span class="p">(</span><span class="s">&#34;50_users_cached/&#34;</span><span class="p">)</span>
<span class="n">cached_25</span> <span class="o">&lt;-</span> <span class="nf">load_runs</span><span class="p">(</span><span class="s">&#34;25_users_cached/&#34;</span><span class="p">)</span>
<span class="n">uncached_5</span> <span class="o">&lt;-</span> <span class="nf">load_runs</span><span class="p">(</span><span class="s">&#34;5_users_uncached/&#34;</span><span class="p">)</span>

<span class="c1"># Merge dataframes</span>
<span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">cached_200</span><span class="p">,</span> <span class="n">cached_100</span><span class="p">,</span> <span class="n">cached_50</span><span class="p">,</span>
            <span class="n">cached_25</span><span class="p">,</span> <span class="n">uncached_5</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">glimpse</span><span class="p">(</span><span class="n">cached_100</span><span class="p">)</span>
</code></pre></div><pre><code>## Observations: 11,886
## Variables: 13
## $ run               &lt;ord&gt; 100_users_cached, 100_users_cached, 100_users_cache…
## $ session_id        &lt;int&gt; 0, 0, 0, 0, 0, 0, 100, 100, 100, 100, 100, 100, 200…
## $ user_id           &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
## $ iteration         &lt;int&gt; 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, …
## $ input_line_number &lt;int&gt; 4, 5, 7, 8, 10, 12, 4, 5, 7, 8, 10, 12, 4, 5, 7, 8,…
## $ event             &lt;chr&gt; &quot;REQ_HOME&quot;, &quot;WS_OPEN&quot;, &quot;WS_RECV_INIT&quot;, &quot;WS_RECV&quot;, &quot;…
## $ start             &lt;dbl&gt; -15.003, -14.974, -14.921, -14.918, -8.782, -4.934,…
## $ end               &lt;dbl&gt; -14.976, -14.944, -14.919, -12.637, -6.348, -1.827,…
## $ time              &lt;dbl&gt; 0.027, 0.030, 0.002, 2.281, 2.434, 3.107, 0.220, 0.…
## $ concurrency       &lt;dbl&gt; 0.0, 1.0, 1.0, 1.0, 41.5, 63.5, 92.5, 89.5, 93.0, 9…
## $ maintenance       &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRU…
## $ label             &lt;ord&gt; Event 1) Get: Homepage, Event 2) Start Session, Eve…
## $ json              &lt;list&gt; [[&quot;REQ_HOME&quot;, 2020-03-01 18:42:58, 2020-03-01 18:4…
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>

<span class="c1"># Plot session times</span>
<span class="n">df</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="nf">summarise</span><span class="p">(</span><span class="n">tot_time</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">time</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  <span class="nf">ggplot</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">tot_time</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">run</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_boxplot</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">trans</span> <span class="o">=</span> <span class="s">&#34;log10&#34;</span><span class="p">,</span> 
                     <span class="n">breaks</span> <span class="o">=</span> <span class="nf">trans_breaks</span><span class="p">(</span><span class="s">&#34;log10&#34;</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="m">10</span><span class="n">^x</span><span class="p">),</span>
                     <span class="n">labels</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="nf">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="m">2</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;25 Users\n Cached&#34;</span><span class="p">,</span> <span class="s">&#34;50 Users\n Cached&#34;</span><span class="p">,</span>
                              <span class="s">&#34;100 Users\n Cached&#34;</span><span class="p">,</span> <span class="s">&#34;200 Users\n Cached&#34;</span><span class="p">,</span>
                              <span class="s">&#34;5 Users\n No Cache&#34;</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;none&#34;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">labs</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="s">&#34;Session time (secs)&#34;</span><span class="p">,</span>
       <span class="n">x</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span>
</code></pre></div><p><img src="/images/2020-03-03-caching-shiny-plots/sess_time-1.png" alt=""><!-- --></p>
<p>As it can be easily noticed, the app supports up to 100 concurrent users
without missing a beat (completely acceptable <em>total session times</em>). At
200 concurrent users, performances start to look similar to the no-cache
scenario. After inspecting computing times with <code>profvis</code>, it can be
noted that the problem is actually the <code>rnorm</code> call trough which mock
data generated.</p>
<p><img src="/images/2020-03-03-caching-shiny-plots/profvis.png" alt=""><br>
Data generation could be made faster by caching the data frame (just
like plots). I haven’t personally explored this as the
<a href="https://github.com/jbryer/DataCache"><code>DataCache</code></a> package looks out of
date and not actively maintained anymore. The good news is that the
relationship between number of users and session time looks linear,
hence throwing more hardware at the problem could be considered as a
stopgap fix.</p>
<h2 id="closing-remarks">Closing remarks</h2>
<p>This post has highlighted that there are undeniable benefits in caching
plots when dealing with multiple concurrent users. The toy examples
described above were tested locally, in a production environment it
considered good practice to run load testing from a different server as
the resources needed to generate fake traffic might influence app
performances.</p>
<p>In order to dig deeper on the test runs, <code>shinyloadtest</code> offers an
extensive html report. The report can be generated after importing and
crunching all the test run files:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">shinyloadtest</span><span class="p">)</span>

<span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">load_runs</span><span class="p">(</span>
  <span class="n">`5_uncached`</span> <span class="o">=</span> <span class="s">&#34;5_users_uncached/&#34;</span><span class="p">,</span>
  <span class="n">`25_cached`</span> <span class="o">=</span> <span class="s">&#34;25_users_cached/&#34;</span><span class="p">,</span>
  <span class="n">`50_cached`</span> <span class="o">=</span> <span class="s">&#34;50_users_cached/&#34;</span><span class="p">,</span>
  <span class="n">`100_cached`</span> <span class="o">=</span> <span class="s">&#34;100_users_cached/&#34;</span><span class="p">,</span>
  <span class="n">`200_cached`</span> <span class="o">=</span> <span class="s">&#34;200_users_cached/&#34;</span>
<span class="p">)</span>

<span class="c1"># Make report</span>
<span class="nf">shinyloadtest_report</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div><h2 id="references">References</h2>
<ul>
<li><a href=""><code>shinyloadtest</code></a>: load testing suite for Shiny applications</li>
<li><a href=""><code>profvis</code></a>: profiler for R applications</li>
<li><a href="https://gist.github.com/andodet/fe390ae45127a80e3e526e63fc3f11bf">toy example
apps</a>
used in this post</li>
<li><a href="https://cran.r-project.org/web/packages/R6/index.html"><code>R6</code></a>:
interface with R6 classes</li>
<li><a href="https://cran.r-project.org/web/packages/redux/index.html"><code>redux</code></a>:
interface package with Redis server</li>
</ul>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  2020 Andrea dodet 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>

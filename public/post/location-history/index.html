<!DOCTYPE html>
<html lang="en-gb">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Digging into Google location history | Andrea Dodet</title>
  <link rel = 'canonical' href = 'https://anddt.com/post/location-history/'>
  <meta name="description" content="Jotting down things I&#39;d like to understand">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Digging into Google location history" />
<meta property="og:description" content="Digging into Google location history  Setup Data preprocess How big is the dataset? Time distribution Data accuracy Plot data on maps Handmade Geocoding - Time spent by city Where was the data collected and for how long? Total distance Activities Extras - Animations  By the end of the year I received a mail from Google with a recap of my location history for 2019 and didn’t pay much attention to it right away ( other than thinking to turn location services off for good)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddt.com/post/location-history/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-01-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-16T00:00:00+00:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Digging into Google location history"/>
<meta name="twitter:description" content="Digging into Google location history  Setup Data preprocess How big is the dataset? Time distribution Data accuracy Plot data on maps Handmade Geocoding - Time spent by city Where was the data collected and for how long? Total distance Activities Extras - Animations  By the end of the year I received a mail from Google with a recap of my location history for 2019 and didn’t pay much attention to it right away ( other than thinking to turn location services off for good)."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://anddt.com/css/styles.7c754dee4bfc873743b12288cf94eadcfd3bee1f2cff5a106753b8047879ac5195c8d8ad90f6d73f12e9c841696c51a0abdeae8394e3eb3079f310f418ddf9ec.css">

  
   <link rel="stylesheet" href="https://anddt.com/custom.css"> 
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://anddt.com/images/favicon.ico" />

  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-58930119-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://anddt.com">
  
    <div id="logo" style="background-image: url(https://anddt.com/logo.png)"></div>
  
  <div id="title">
    <h1>Andrea Dodet</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fas fa-bars fa-2x" aria-hidden="true"></i></a>
      </li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <h1 id="digging-into-google-location-history">Digging into Google location history</h1>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#data-preprocess">Data preprocess</a></li>
<li><a href="#how-big-is-the-dataset">How big is the dataset?</a></li>
<li><a href="#time-distribution">Time distribution</a></li>
<li><a href="#data-accuracy">Data accuracy</a></li>
<li><a href="#plot-data-on-maps">Plot data on maps</a></li>
<li><a href="#handmade-geocoding---time-spent-by-city">Handmade Geocoding - Time spent by
city</a></li>
<li><a href="#where-was-the-data-collected-and-for-how-long">Where was the data collected and for how
long?</a></li>
<li><a href="#total-distance">Total distance</a></li>
<li><a href="#activities">Activities</a></li>
<li><a href="#extras---animations">Extras - Animations</a></li>
</ul>
<p>By the end of the year I received a mail from Google with a recap of my
location history for 2019 and didn’t pay much attention to it right away
( other than thinking to turn location services off for good). Since the
data is available (you can download from <a href="https://takeout.google.com/settings/takeout">Google
Takeout</a>), I thought it’d
be fun to poke into it and get something out of it.<br>
I’ve ditched my iPhone 4s in 2013 and sticked to Android ever since,
totaling almost 6 full years worth of location history
(<code>Takeout/Location History.json</code> totals ~420mb). Since dealing with
large json files can be slow in R, exporting a serialized dataset with
<code>saveRDS</code> can speed things up a fair bit.</p>
<p>The raw notebook can be found in <a href="https://github.com/andodet/notebooks/blob/master/location-history/location-history.md">this</a> github repo.</p>
<h2 id="setup">Setup</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#50fa7b">options</span>(scipen <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">999</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#50fa7b">library</span>(dplyr)
<span style="color:#50fa7b">library</span>(jsonlite)
<span style="color:#50fa7b">library</span>(ggplot2)
<span style="color:#50fa7b">library</span>(gridExtra)
<span style="color:#50fa7b">library</span>(grid)
<span style="color:#50fa7b">library</span>(scales)
<span style="color:#50fa7b">library</span>(ggmap)  <span style="color:#6272a4"># to draw fancy maps</span>
<span style="color:#50fa7b">library</span>(raster)  <span style="color:#6272a4"># to calc distances between latlon</span>
</code></pre></div><p><code>ggmap</code> will require providing Google API key (billing will need to be
set up and a credit card will be required). This can be done in two
ways:</p>
<ul>
<li>exporting an environment variable via <code>export GMAPS_API_TOKEN=&quot;your_token_string</code>.</li>
<li>reading the token from an <code>.env</code> file I put in the project
directory. I will favor this method since I don’t really like to
export a variable in <code>~/.zshrc</code> for a one-off analysis.<br>
<strong>For the love of god, remember to add that file to <code>.gitignore</code> to
avoid accidentally pushing it to Github.</strong></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Set gMaps api key</span>
<span style="color:#50fa7b">register_google</span>(key <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">read.dcf</span>(
  <span style="color:#f1fa8c">&#34;.env&#34;</span>,
  fields <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;GMAPS_API_TOKEN&#34;</span>
))
</code></pre></div><h2 id="data-preprocess">Data preprocess</h2>
<p>Data comes out with a number of nested fields so we’ll need to flatten
the json fille after reading it into memory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">data <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">fromJSON</span>(<span style="color:#f1fa8c">&#34;Takeout/Location History/Location History.json&#34;</span>)
data <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">flatten</span>(data<span style="color:#ff79c6">$</span>locations)
</code></pre></div><p>In order to be consumed, couple adjustments are needed:</p>
<ul>
<li>converting timestamps to <code>UNIX</code> format</li>
<li>converting lat-lon coordinates to GPS format to be able to draw maps</li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Convert timestamps to UNIX format</span>
norm_ts <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">function</span>(x) {
  <span style="color:#50fa7b">as.POSIXct</span>(<span style="color:#50fa7b">as.numeric</span>(x) <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">1000</span>,
             origin <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;1970-01-01&#34;</span>)
}

<span style="color:#6272a4"># Normalise timestamps</span>
data <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">mutate</span>(timestampMs <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">norm_ts</span>(timestampMs),
         date <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">as.Date</span>(timestampMs, <span style="color:#f1fa8c">&#34;%Y-%m-%d&#34;</span>))

<span style="color:#6272a4"># Convert E7 lat lon to GPS coordinates</span>
data <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">mutate</span>(latitudeGPS <span style="color:#ff79c6">=</span> latitudeE7 <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">1e7</span>,
         longitudeGPS <span style="color:#ff79c6">=</span> longitudeE7 <span style="color:#ff79c6">/</span> <span style="color:#bd93f9">1e7</span>)
</code></pre></div><p>After the transformations mentioned above, the final dataset will have
the following structure:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#50fa7b">glimpse</span>(data)
</code></pre></div><pre><code>## Observations: 1,183,157
## Variables: 12
## $ timestampMs      &lt;dttm&gt; 2013-12-23 03:18:34, 2013-12-23 03:19:34, 2013-12-2…
## $ latitudeE7       &lt;int&gt; 418713521, 418713478, 418714064, 418714201, 41871341…
## $ longitudeE7      &lt;int&gt; 124414861, 124414780, 124415342, 124415539, 12441475…
## $ accuracy         &lt;int&gt; 14, 34, 30, 30, 32, 32, 32, 30, 32, 30, 28, 30, 28, …
## $ activity         &lt;list&gt; [NULL, NULL, NULL, &lt;data.frame[1 x 2]&gt;, NULL, &lt;data…
## $ altitude         &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ velocity         &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ heading          &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ verticalAccuracy &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ date             &lt;date&gt; 2013-12-23, 2013-12-23, 2013-12-23, 2013-12-23, 201…
## $ latitudeGPS      &lt;dbl&gt; 41.87135, 41.87135, 41.87141, 41.87142, 41.87134, 41…
## $ longitudeGPS     &lt;dbl&gt; 12.44149, 12.44148, 12.44153, 12.44155, 12.44148, 12…
</code></pre>
<ul>
<li><code>timestamp</code>: original timestamps (in milliseconds) are now converted
to date objects</li>
<li><code>accuracy</code>: the distance around the point in meters</li>
<li><code>verticalAccuracy</code>: accuracy measured on a vertical dimension (in
meters)</li>
<li><code>activity</code>: a list of nested dataframes with an inference on the
type of activity (analysed further down)</li>
<li><code>latitudeGPS</code>: latitude converted to GPS format</li>
<li><code>longitudeGPS</code>: same as above for longitude values</li>
</ul>
<h2 id="how-big-is-the-dataset">How big is the dataset?</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#50fa7b">min</span>(data<span style="color:#ff79c6">$</span>timestampMs)
</code></pre></div><pre><code>## [1] &quot;2013-12-23 03:18:34 CET&quot;
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#50fa7b">max</span>(data<span style="color:#ff79c6">$</span>timestampMs)
</code></pre></div><pre><code>## [1] &quot;2020-01-13 18:07:27 CET&quot;
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">time_diff <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">max</span>(data<span style="color:#ff79c6">$</span>timestampMs) <span style="color:#ff79c6">-</span> <span style="color:#50fa7b">min</span>(data<span style="color:#ff79c6">$</span>timestampMs)
n_points <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">nrow</span>(data)
</code></pre></div><p>It seems that Google has collected 1183157 over a period of 2212.62 days
(or 6.06 years).</p>
<h2 id="time-distribution">Time distribution</h2>
<p>For some reason the number of data points collected falls sharply during
summer ’17. Around that time I was moving back to Italy (after around
five years spent in Denmark and the UK). During that time I was
job-hunting and have moved aronud less frequently, it would be
interesting to understand if a less dynamic lifestyle is negatively
correlated to the number of data points collected.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Get points collected over time</span>
dp_trend <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">group_by</span>(year_month <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">as.Date</span>(<span style="color:#50fa7b">format</span>(timestampMs, <span style="color:#f1fa8c">&#34;%Y-%m-01&#34;</span>))) <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">summarise</span>(obs <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">n</span>())

<span style="color:#6272a4"># Get points collected by year, month and day</span>
dp_daily <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">data.frame</span>(<span style="color:#50fa7b">table</span>(
  <span style="color:#50fa7b">format</span>(data<span style="color:#ff79c6">$</span>timestampMs, <span style="color:#f1fa8c">&#34;%Y-%m-%d&#34;</span>)), group <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;day&#34;</span>)

dp_monthly <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">data.frame</span>(<span style="color:#50fa7b">table</span>(
  <span style="color:#50fa7b">format</span>(data<span style="color:#ff79c6">$</span>timestampMs, <span style="color:#f1fa8c">&#34;%Y-%m&#34;</span>)), group <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;month&#34;</span>)

dp_yearly <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">data.frame</span>(<span style="color:#50fa7b">table</span>(
  <span style="color:#50fa7b">format</span>(data<span style="color:#ff79c6">$</span>timestampMs, <span style="color:#f1fa8c">&#34;%Y&#34;</span>)), group <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;year&#34;</span>)

dp <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">rbind</span>(dp_daily[,<span style="color:#bd93f9">-1</span>], dp_monthly[,<span style="color:#bd93f9">-1</span>], dp_yearly[,<span style="color:#bd93f9">-1</span>])
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Data points collected over time</span>
trend <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggplot</span>(dp_trend, <span style="color:#50fa7b">aes</span>(year_month, obs)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_bar</span>(stat <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;identity&#34;</span>, fill <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tomato&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">scale_y_continuous</span>(breaks <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">seq</span>(<span style="color:#bd93f9">0</span>, <span style="color:#50fa7b">max</span>(dp_trend<span style="color:#ff79c6">$</span>obs), <span style="color:#bd93f9">2000</span>)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">scale_x_date</span>(labels <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">date_format</span>(<span style="color:#f1fa8c">&#34;%Y-%m&#34;</span>), breaks <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;3 month&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme_light</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme</span>(axis.text.x <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">element_text</span>(angle <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">90</span>)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Number of data points collected over time&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Year-Month&#34;</span>,
       y <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;n. Data points&#34;</span>)

<span style="color:#6272a4"># Daily, monthly, yearly collected data points</span>
time_dist <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggplot</span>(dp, <span style="color:#50fa7b">aes</span>(group, Freq)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_point</span>(position <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">position_jitter</span>(width <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.2</span>), alpha <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">.3</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_boxplot</span>(<span style="color:#50fa7b">aes</span>(colour <span style="color:#ff79c6">=</span> group), outlier.colour <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">NA</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">facet_grid</span>(group <span style="color:#ff79c6">~</span> ., scales <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;free&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme_light</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Distribution of collected data points&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;period&#34;</span>,
       y <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;n. data points&#34;</span>)

<span style="color:#50fa7b">grid.arrange</span>(trend, time_dist, nrow <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>)
</code></pre></div><p><!-- raw HTML omitted --></p>
<h2 id="data-accuracy">Data accuracy</h2>
<p>As mentioned above, the dataset contains an <code>accuracy</code> field we can use
to get a rough sense of how accurate the collected data is. The most
accurate measurements fall in the region of +/- 60mt, with the vast
majority of observations falling in the <em>accurate</em> category. From the
graph below, it seems there are periods of time (specifically during the
summer period) where accuracy degrades consistently. I do believe that
this might be caused by the fact that I spent the last few summer breaks
in places with sub par network connection, hence the GPS might have had a
hard time pinpointing my exact location.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Create accuracy categorical variable =</span>
acc <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span>
  dplyr<span style="color:#ff79c6">::</span><span style="color:#50fa7b">select</span>(accuracy, timestampMs, date, latitudeGPS, longitudeGPS) <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">filter</span>(<span style="color:#ff79c6">!</span><span style="color:#50fa7b">is.na</span>(accuracy)) <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">filter</span>(accuracy <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">30000</span>) <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">mutate</span>(accuracy_g <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">factor</span>(x <span style="color:#ff79c6">=</span> (<span style="color:#50fa7b">case_when</span>(accuracy <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">800</span> <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#34;high&#34;</span>,
                                            accuracy <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">5000</span> <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#34;mid&#34;</span>,
                                            <span style="color:#ff79c6">TRUE</span> <span style="color:#ff79c6">~</span> <span style="color:#f1fa8c">&#34;low&#34;</span>)),
                             levels <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">c</span>(<span style="color:#f1fa8c">&#34;low&#34;</span>, <span style="color:#f1fa8c">&#34;mid&#34;</span>, <span style="color:#f1fa8c">&#34;high&#34;</span>)))

<span style="color:#6272a4"># Accuracy by week</span>
acc_weekly <span style="color:#ff79c6">&lt;-</span> acc <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">group_by</span>(date <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">cut.Date</span>(<span style="color:#50fa7b">as.Date</span>(timestampMs, <span style="color:#f1fa8c">&#34;%Y-%m-%d&#34;</span>),
                           <span style="color:#f1fa8c">&#34;week&#34;</span>)) <span style="color:#ff79c6">%&gt;%</span>  
  <span style="color:#50fa7b">summarise</span>(avg_accuracy <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">mean</span>(accuracy))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Plot accuracy distribution</span>
acc_dist <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggplot</span>(acc, <span style="color:#50fa7b">aes</span>(accuracy, fill <span style="color:#ff79c6">=</span> accuracy_g)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_histogram</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">scale_x_log10</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">facet_grid</span>(accuracy_g <span style="color:#ff79c6">~</span> ., scales <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;free&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme_light</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme</span>(axis.text.x <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">element_text</span>(angle <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">90</span>)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Accuracy Distribution&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;log. accuracy (meters)&#34;</span>,
       y <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;n. observation&#34;</span>)

<span style="color:#6272a4"># Plot weekly accuracy</span>
acc_trend <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggplot</span>(acc_weekly, <span style="color:#50fa7b">aes</span>(<span style="color:#50fa7b">as.Date</span>(date), avg_accuracy, group <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_line</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">scale_x_date</span>(labels <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">date_format</span>(<span style="color:#f1fa8c">&#34;%Y-%m&#34;</span>), breaks <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;3 month&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Accuracy over time&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;month&#34;</span>,
       y <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;avg. accuract (lower is better)&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme_light</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme</span>(axis.text.x <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">element_text</span>(angle <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">90</span>))

<span style="color:#50fa7b">grid.arrange</span>(acc_dist, acc_trend, ncol <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>)
</code></pre></div><p><img src="/images/2020-01-16-location-history/accuracy_plots-1.png" alt=""><!-- raw HTML omitted --></p>
<h2 id="plot-data-on-maps">Plot data on maps</h2>
<p>Over the past 7 years I had the lucky opportunity to study and work in 3
European cities (Milan, Copenhagen and London). Using
<a href="https://github.com/dkahle/ggmap"><code>ggmap</code></a> we can easily plot location
data on maps using the good old <code>ggplot</code> syntax.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Retrieve maps from Google Maps api</span>
maps <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">list</span>(
  Europe     <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">get_map</span>(<span style="color:#f1fa8c">&#34;Europe&#34;</span>, zoom <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>),
  Italy      <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">get_map</span>(<span style="color:#f1fa8c">&#34;Italy&#34;</span>, zoom <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">6</span>),
  London     <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">get_map</span>(<span style="color:#f1fa8c">&#34;London&#34;</span>, zoom <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">12</span>),
  Copenhagen <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">get_map</span>(<span style="color:#f1fa8c">&#34;Copenhagen&#34;</span>, zoom <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">12</span>),
  Rome       <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">get_map</span>(<span style="color:#f1fa8c">&#34;Rome&#34;</span>, zoom <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">12</span>)
)

<span style="color:#6272a4"># Plot points in locations iteratively</span>
plots <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">list</span>()
<span style="color:#50fa7b">for </span>(city in <span style="color:#50fa7b">names</span>(maps)) {
    p <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggmap</span>(maps[[city]]) <span style="color:#ff79c6">+</span>
      <span style="color:#50fa7b">geom_point</span>(data <span style="color:#ff79c6">=</span> data, <span style="color:#50fa7b">aes</span>(longitudeGPS, latitudeGPS), alpha <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.01</span>, colour <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tomato&#34;</span>,
           size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.6</span>) <span style="color:#ff79c6">+</span> 
      <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">paste0</span>(<span style="color:#f1fa8c">&#34;Locations in &#34;</span>, city)) <span style="color:#ff79c6">+</span>
      <span style="color:#50fa7b">theme</span>(plot.margin <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">unit</span>(<span style="color:#50fa7b">c</span>(<span style="color:#bd93f9">0.1</span>, <span style="color:#bd93f9">0.1</span>, <span style="color:#bd93f9">0.1</span>, <span style="color:#bd93f9">0.1</span>), <span style="color:#f1fa8c">&#34;cm&#34;</span>))
    
    plots[[city]] <span style="color:#ff79c6">&lt;-</span> p
}

<span style="color:#6272a4"># Output plots </span>
plot_grid <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">do.call</span>(<span style="color:#f1fa8c">&#34;grid.arrange&#34;</span>, <span style="color:#50fa7b">c</span>(plots, ncol <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>))
<span style="color:#50fa7b">grid.draw</span>(plot_grid)
</code></pre></div><p><img src="/images/2020-01-16-location-history/unnamed-chunk-5-1.png" alt=""><!-- raw HTML omitted --></p>
<p>For the sake of curiosity we can also check for any pattern in data
accurcacy within a specific city. The same could be done with <code>velocity</code>
to inspect if there’s any area that registered faster movements (morning
commute, motorbike trips, etc.).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Plot accuracy in London</span>
ldn_acc <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggmap</span>(maps<span style="color:#ff79c6">$</span>London) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">stat_summary_2d</span>(geom <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tile&#34;</span>, bins <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">100</span>, data <span style="color:#ff79c6">=</span> data, <span style="color:#50fa7b">aes</span>(longitudeGPS,
                                                            latitudeGPS,
                                                            z <span style="color:#ff79c6">=</span> accuracy),
                alpha <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.5</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">scale_fill_gradient</span>(low <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;blue&#34;</span>, high <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;red&#34;</span>, <span style="color:#50fa7b">guide_legend</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;accuracy&#34;</span>)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Data Accuracy (meters) in London&#34;</span>)

ldn_acc
</code></pre></div><p><img src="/images/2020-01-16-location-history/unnamed-chunk-6-1.png" alt=""><!-- raw HTML omitted --></p>
<h2 id="handmade-geocoding---time-spent-by-city">Handmade Geocoding - Time spent by city</h2>
<p>Another question I was interested to answer was how much time did I
spend in each city I’ve lived in. Sadly the dataset doesn’t have any
label to mark the city where the data point was collected in. Here I’ve
evaluated couple strategies to move forward:</p>
<ul>
<li>❌️ Use <a href="https://docs.mapbox.com/api/search/">MapBox free geocoding
API</a> is a no-go as it would
take too long to process 1.3M rows (request/minute are limited).</li>
<li>❌ Shell out some money for Google Maps API – wasn’t really feeling
to hit API quotas or spend recklessly.</li>
<li>✔ Do it in hacky way using <a href="http://www.partow.net/miscellaneous/airportdatabase/#Download">airport
coordinates</a>
as reference points. The underlying logic assumes that if data was
collected within a range of <strong>50 km</strong> (arbitrary cutoff value), it
is safe to assume that I was in the the same city where the airport
is located.</li>
</ul>
<p>After downloading, unzipping and reading airport coordinates, they can
be consumed as lat/lon coordinates.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Download cities coordinates (http://www.partow.net/miscellaneous/airportdatabase/index.html#Downloads)</span>
tmpFile <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">tempfile</span>()
<span style="color:#50fa7b">download.file</span>(<span style="color:#f1fa8c">&#34;http://www.partow.net/downloads/GlobalAirportDatabase.zip&#34;</span>,
              tmpFile)

airport_coords <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">read.csv</span>(
  <span style="color:#50fa7b">unzip</span>(tmpFile, <span style="color:#f1fa8c">&#34;GlobalAirportDatabase.txt&#34;</span>),
  sep <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;:&#34;</span>,
  stringsAsFactors <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">FALSE</span>,
  header <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">FALSE</span>
)

<span style="color:#50fa7b">head</span>(<span style="color:#50fa7b">as_tibble</span>(airport_coords), <span style="color:#bd93f9">3</span>)
</code></pre></div><pre><code>## # A tibble: 3 x 16
##   V1    V2    V3     V4    V5       V6    V7    V8 V9      V10   V11   V12 V13  
##   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;
## 1 AYGA  GKA   GOROKA GORO… PAPU…     6     4    54 S       145    23    30 E    
## 2 AYLA  LAE   N/A    LAE   PAPU…     0     0     0 U         0     0     0 U    
## 3 AYMD  MAG   MADANG MADA… PAPU…     5    12    25 S       145    47    19 E    
## # … with 3 more variables: V14 &lt;int&gt;, V15 &lt;dbl&gt;, V16 &lt;dbl&gt;
</code></pre>
<p>Geocoding cities ourselves will involve performing the following steps:</p>
<ol>
<li>Compute distances between my location history and the airports</li>
<li>Finding out which the closest airport is</li>
<li>Grabbing the city label from the airport dataset.</li>
</ol>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Filter relevant airports</span>
airport_coords <span style="color:#ff79c6">&lt;-</span> airport_coords <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">filter</span>(V2 <span style="color:#ff79c6">%in%</span> <span style="color:#50fa7b">c</span>(<span style="color:#f1fa8c">&#34;FCO&#34;</span>, <span style="color:#f1fa8c">&#34;MXP&#34;</span>, <span style="color:#f1fa8c">&#34;LCY&#34;</span>, <span style="color:#f1fa8c">&#34;CPH&#34;</span>))

<span style="color:#6272a4"># Compute distances</span>
distmat <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">pointDistance</span>(
  <span style="color:#50fa7b">matrix</span>(<span style="color:#50fa7b">c</span>(data<span style="color:#ff79c6">$</span>longitudeGPS, data<span style="color:#ff79c6">$</span>latitudeGPS), ncol <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>),
  <span style="color:#50fa7b">matrix</span>(<span style="color:#50fa7b">c</span>(airport_coords<span style="color:#ff79c6">$</span>V16, airport_coords<span style="color:#ff79c6">$</span>V15), ncol <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>),
  lonlat <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>
  )

<span style="color:#6272a4"># Get city label and distance to nearest airport</span>
data<span style="color:#ff79c6">$</span>nearest_airport <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">apply</span>(
  distmat, <span style="color:#bd93f9">1</span>, <span style="color:#50fa7b">function</span>(x){
    <span style="color:#50fa7b">if </span>(x<span style="color:#50fa7b">[which.min</span>(x)] <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">50000</span>) airport_coords<span style="color:#ff79c6">$</span>V4<span style="color:#50fa7b">[which.min</span>(x)] else <span style="color:#ff79c6">NA</span>
  }
)

data<span style="color:#ff79c6">$</span>dist_nearest_airport <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">apply</span>(distmat, <span style="color:#bd93f9">1</span>, min)
</code></pre></div><p>Which will provide 2 new columns:</p>
<ul>
<li><code>dist_nearest_airport</code>: distance (in meters) to the nearest airport,
selected from a subset</li>
<li><code>nearest_airport</code>: label with the city where the nearest airport is
located</li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">data <span style="color:#ff79c6">%&gt;%</span> 
  dplyr<span style="color:#ff79c6">::</span><span style="color:#50fa7b">select</span>(latitudeGPS, longitudeGPS, dist_nearest_airport, nearest_airport) <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">head</span>(<span style="color:#bd93f9">3</span>)
</code></pre></div><pre><code>##   latitudeGPS longitudeGPS dist_nearest_airport nearest_airport
## 1    41.87135     12.44149             16943.33            ROME
## 2    41.87135     12.44148             16942.53            ROME
## 3    41.87141     12.44153             16949.33            ROME
</code></pre>
<h2 id="where-was-the-data-collected-and-for-how-long">Where was the data collected and for how long?</h2>
<p>It is now possible to plot the number of datapoints collected and the
number of days spent in each city.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Data points by city</span>
cities_rank <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">group_by</span>(city <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">as.factor</span>(nearest_airport)) <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">count</span>() <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">arrange</span>(<span style="color:#50fa7b">desc</span>(n))

<span style="color:#6272a4"># Distinct days by city</span>
city_time <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">group_by</span>(city <span style="color:#ff79c6">=</span> nearest_airport) <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">summarise</span>(n_days <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">n_distinct</span>(date)) <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">arrange</span>(<span style="color:#50fa7b">desc</span>(n_days))

cities_rank_p <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggplot</span>(cities_rank, <span style="color:#50fa7b">aes</span>(<span style="color:#50fa7b">reorder</span>(city, <span style="color:#ff79c6">-</span>n), n, fill <span style="color:#ff79c6">=</span> city)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_bar</span>(stat <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;identity&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme_light</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Number of data points collected by city&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;city&#34;</span>,
       y <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;obs&#34;</span>)

city_time_p <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggplot</span>(city_time, <span style="color:#50fa7b">aes</span>(<span style="color:#50fa7b">reorder</span>(city, <span style="color:#ff79c6">-</span>n_days), n_days, fill <span style="color:#ff79c6">=</span> city)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_bar</span>(stat <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;identity&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme_light</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Number of days spent in city&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;city&#34;</span>,
       y <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;n days&#34;</span>)

<span style="color:#50fa7b">grid.arrange</span>(cities_rank_p, city_time_p)
</code></pre></div><p><img src="/images/2020-01-16-location-history/cities_rank-1.png" alt=""><!-- raw HTML omitted --></p>
<h2 id="total-distance">Total distance</h2>
<p>In order to retrieve the total distance I’ve covered over the years, it
is needed to compute the distance between each location and the previous
one. Judging from the plot below <em>2018</em>  needs some further inspection, as its
values look suspicious and might be originated by some outliers (beyond the scope of this notebook).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#6272a4"># Lag coordinates to calculate point distance</span>
dist_df <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">mutate</span>(latitudeGPS_lag <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">lag</span>(latitudeGPS, <span style="color:#bd93f9">1</span>),
         longitudeGPS_lag <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">lag</span>(longitudeGPS, <span style="color:#bd93f9">1</span>))

<span style="color:#6272a4"># Calculate distance (in meterss) between every point</span>
dist_df<span style="color:#ff79c6">$</span>dist_to_prev <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">pointDistance</span>(
  <span style="color:#50fa7b">matrix</span>(<span style="color:#50fa7b">c</span>(dist_df<span style="color:#ff79c6">$</span>latitudeGPS_lag, dist_df<span style="color:#ff79c6">$</span>longitudeGPS_lag), ncol <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>),
  <span style="color:#50fa7b">matrix</span>(<span style="color:#50fa7b">c</span>(dist_df<span style="color:#ff79c6">$</span>latitudeGPS, dist_df<span style="color:#ff79c6">$</span>longitudeGPS), ncol <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>),
  lonlat <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">dist_month <span style="color:#ff79c6">&lt;-</span> dist_df <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">group_by</span>(month <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">format</span>(timestampMs, <span style="color:#f1fa8c">&#34;%m&#34;</span>),
           year <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">format</span>(timestampMs, <span style="color:#f1fa8c">&#34;%Y&#34;</span>)) <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">filter</span>(<span style="color:#ff79c6">!</span>year <span style="color:#ff79c6">%in%</span> <span style="color:#50fa7b">c</span>(<span style="color:#f1fa8c">&#34;2020&#34;</span>, <span style="color:#f1fa8c">&#34;2013&#34;</span>)) <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">summarise</span>(total_dist <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">sum</span>(dist_to_prev<span style="color:#ff79c6">*</span><span style="color:#bd93f9">0.001</span>, na.rm <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">TRUE</span>))

<span style="color:#50fa7b">ggplot</span>(dist_month, <span style="color:#50fa7b">aes</span>(month, total_dist)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_bar</span>(stat <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;identity&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">facet_grid</span>(year <span style="color:#ff79c6">~</span> ., scales <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;free&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Total distance covered&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;month&#34;</span>,
       y <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tot. distance (meters)&#34;</span>)
</code></pre></div><p><img src="/images/2020-01-16-location-history/dist_year-1.png" alt=""><!-- raw HTML omitted --></p>
<h2 id="activities">Activities</h2>
<p>It seems that while collecting data, Google also infers the type of
activity we’re performing. This predictions can be found in the nested
dataframes located in the <code>activity</code> column. I will only look at
<strong>2018</strong> as unnesting large amounts of nested data can take quite a
while. Surprisingly enough, it looks like I’ve spent most of my time
still, which does make sense, given I spend most of my time sitting at a desk.
Without knowing how this predictions are produced it’s hard to tell whether or not it is accurate.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">activities <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">bind_rows</span>(data<span style="color:#ff79c6">$</span>activity)  <span style="color:#6272a4"># Get df of activities</span>

<span style="color:#6272a4"># Unnest activity dataframes</span>
activities <span style="color:#ff79c6">&lt;-</span> activities <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">mutate</span>(timestampMs <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">norm_ts</span>(timestampMs)) <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">filter</span>(<span style="color:#50fa7b">format</span>(timestampMs, <span style="color:#f1fa8c">&#34;%Y&#34;</span>) <span style="color:#ff79c6">%in%</span> <span style="color:#bd93f9">2018</span>) <span style="color:#ff79c6">%&gt;%</span>
  tidyr<span style="color:#ff79c6">::</span><span style="color:#50fa7b">unnest</span>(., activity)    
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">activities_rank <span style="color:#ff79c6">&lt;-</span> activities_df <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">group_by</span>(type) <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">count</span>()

<span style="color:#50fa7b">ggplot</span>(activities_rank, <span style="color:#50fa7b">aes</span>(<span style="color:#50fa7b">reorder</span>(type, <span style="color:#ff79c6">-</span>n), n, fill <span style="color:#ff79c6">=</span> type)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_bar</span>(stat <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;identity&#34;</span>) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme_light</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">theme</span>(axis.text.x <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">element_text</span>(angle <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">90</span>)) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Main activities in 2018&#34;</span>,
       x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>)
</code></pre></div><p><img src="/images/2020-01-16-location-history/unnamed-chunk-8-1.png" alt=""><!-- raw HTML omitted --></p>
<h2 id="extras---animations">Extras - Animations</h2>
<p>The data spans across several years, with London being the city where
I’ve generated data for the longest period of time. Through
<a href="https://github.com/thomasp85/gganimate"><code>gganimate</code></a> we can visualise
the evolution of the recorded locations on a map.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#50fa7b">library</span>(gganimate)

<span style="color:#6272a4"># Get London data</span>
ldn_2018 <span style="color:#ff79c6">&lt;-</span> data <span style="color:#ff79c6">%&gt;%</span> 
  <span style="color:#50fa7b">filter</span>(<span style="color:#50fa7b">format</span>(date, <span style="color:#f1fa8c">&#34;%Y&#34;</span>) <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">2016</span>,
         <span style="color:#50fa7b">format</span>(date, <span style="color:#f1fa8c">&#34;%Y&#34;</span>) <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">2019</span>,
         nearest_airport <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;LONDON&#34;</span>) <span style="color:#ff79c6">%&gt;%</span>
  <span style="color:#50fa7b">mutate</span>(month <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">as.integer</span>(<span style="color:#50fa7b">format</span>(date, <span style="color:#f1fa8c">&#34;%m&#34;</span>)))

ldn_anim <span style="color:#ff79c6">&lt;-</span> <span style="color:#50fa7b">ggmap</span>(maps<span style="color:#ff79c6">$</span>London) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">geom_point</span>(data <span style="color:#ff79c6">=</span> ldn_2018, <span style="color:#50fa7b">aes</span>(longitudeGPS, latitudeGPS), alpha <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.01</span>, colour <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;tomato&#34;</span>,
       size <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.6</span>) <span style="color:#ff79c6">+</span> 
  <span style="color:#50fa7b">theme</span>(plot.margin <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">unit</span>(<span style="color:#50fa7b">c</span>(<span style="color:#bd93f9">0.1</span>, <span style="color:#bd93f9">0.1</span>, <span style="color:#bd93f9">0.1</span>, <span style="color:#bd93f9">0.1</span>), <span style="color:#f1fa8c">&#34;cm&#34;</span>)) <span style="color:#ff79c6">+</span>
  <span style="color:#6272a4"># This is the gganimate-related bit</span>
  <span style="color:#50fa7b">transition_time</span>(month) <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">enter_fade</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">ease_aes</span>() <span style="color:#ff79c6">+</span>
  <span style="color:#50fa7b">labs</span>(title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Locations in London&#34;</span>)

<span style="color:#50fa7b">animate</span>(ldn_anim, renderer <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">gifski_renderer</span>(<span style="color:#f1fa8c">&#34;ldn_2018.gif&#34;</span>))
</code></pre></div><p><img src="/images/2020-01-16-location-history/ldn_2018.gif" alt=""><!-- raw HTML omitted --></p>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  2021 Andrea dodet 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
